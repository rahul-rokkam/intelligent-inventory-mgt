resources:
  jobs:
    full_sync:
      name: "[${bundle.target}] SmartStock - Full Sync"
      
      # Grant permissions to all workspace users to run this job
      permissions:
        - group_name: users
          level: CAN_MANAGE_RUN

      tasks:
        - task_key: data_generation
          run_job_task:
            job_id: ${resources.jobs.data_initialization.id}

        - task_key: model_training
          depends_on:
            - task_key: data_generation
          notebook_task:
            notebook_path: "../../src/smartstock_v2/Model training.py"
            base_parameters:
              catalog: ${var.catalog_name}
              env: ${bundle.target}

        - task_key: model_inference
          depends_on:
            - task_key: model_training
          notebook_task:
            notebook_path: "../../src/smartstock_v2/Model Inference and Recommendations.py"
            base_parameters:
              catalog: ${var.catalog_name}
              env: ${bundle.target}

        - task_key: tables_sync_1st_pass
          depends_on:
            - task_key: data_generation
          notebook_task:
            notebook_path: "../../src/smartstock_v2/Tables sync - 1st pass.py"
            base_parameters:
              catalog: ${var.catalog_name}
              env: ${bundle.target}
              dim_product_pipeline_id: ${var.dim_product_pipeline_id}
              dim_warehouse_pipeline_id: ${var.dim_warehouse_pipeline_id}
              fact_transactions_pipeline_id: ${var.fact_transactions_pipeline_id}
              inventory_historical_pipeline_id: ${var.inventory_historical_pipeline_id}

        - task_key: tables_sync_2nd_pass
          depends_on:
            - task_key: model_inference
          notebook_task:
            notebook_path: "../../src/smartstock_v2/Tables sync - 2nd pass.py"
            base_parameters:
              catalog: ${var.catalog_name}
              env: ${bundle.target}
              inventory_forecast_pipeline_id: ${var.inventory_forecast_pipeline_id}

      queue:
        enabled: true